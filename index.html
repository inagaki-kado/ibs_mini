<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ITABASHI BEYBLADE HUD - Ver.27.1 Font Fixed</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@1,700&family=Orbitron:wght@900&display=swap" rel="stylesheet">

    <style>
        /* デジタル数字フォント（これのみローカルファイルが必要です） */
        @font-face { 
            font-family: 'DSEG7 Classic'; 
            src: url('./font/DSEG7Classic-BoldItalic.ttf') format('truetype'); 
            font-weight: bold; 
            font-style: italic; 
        }

        :root {
            --bx-green: #b6ff00; --bx-blue: #00eaff; --bx-orange: #ffaa00;
            --bx-red-orange: #ff4500; --bx-red: #ff0055;
            --bx-yellow: #fff000;
            --safe-left: env(safe-area-inset-left); --safe-right: env(safe-area-inset-right);
        }

        body { 
            margin: 0; padding: 0; background: black; 
            font-family: 'Chakra Petch', sans-serif; overflow: hidden; color: white; 
            -webkit-tap-highlight-color: transparent; transition: background-color 0.3s;
            touch-action: none; /* ズーム自作のため */
        }

        /* 全ての入力欄とボタンにフォントを強制適用 */
        input, button, .score, .hud-btn, .system-btn {
            font-family: inherit;
        }

        body.green-mode { background-color: #00ff00 !important; }
        
        #video-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; overflow: hidden; }
        #camera-bg, #replay-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform-origin: center center; }
        #replay-video { z-index: 10; display: none; background: black; }
        
        .scan-line { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 3px); pointer-events: none; }

        /* システムボタン */
        .system-btn { 
            position: fixed; z-index: 80; background: rgba(0,0,0,0.5); color: #aaa; border: 1px solid #555; 
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-size: 14px; font-weight: 900; cursor: pointer; border-radius: 8px; outline: none; transition: 0.3s;
            font-family: 'Orbitron', sans-serif !important;
        }
        .system-btn:hover { color: var(--bx-green); }
        .btn-reset { top: 20px; left: max(20px, calc(var(--safe-left) + 20px)); } 
        .btn-bg { bottom: 20px; left: max(20px, calc(var(--safe-left) + 20px)); }
        .btn-rotate { bottom: 20px; left: max(80px, calc(var(--safe-left) + 75px)); color: var(--bx-blue); border-color: var(--bx-blue); }
        .btn-mic { bottom: 20px; left: max(140px, calc(var(--safe-left) + 130px)); }
        .btn-mic.active { color: white; background: var(--bx-red); border-color: white; box-shadow: 0 0 10px var(--bx-red); }

        .btn-timer { top: 20px; right: max(20px, calc(var(--safe-right) + 20px)); } 
        .btn-timer-toggle { top: 20px; right: max(80px, calc(var(--safe-right) + 75px)); color: var(--bx-blue); }
        .btn-winpoint { bottom: 20px; right: max(20px, calc(var(--safe-right) + 20px)); color: var(--bx-orange); font-size: 18px; }

        body.pro-mode .system-btn { display: none !important; }

        /* リプレイUI */
        #replay-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; font-family: 'Orbitron', sans-serif; font-size: 40px; color: var(--bx-red); text-shadow: 0 0 20px var(--bx-red); font-weight: 900; font-style: italic; display: none; letter-spacing: 5px; animation: blink 1s infinite; pointer-events: none; }
        #replay-status { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 100; font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900; background: rgba(0, 0, 0, 0.7); padding: 10px 30px; border-radius: 50px; border: 2px solid var(--bx-red); color: white; display: none; box-shadow: 0 0 20px rgba(255, 0, 85, 0.3); letter-spacing: 2px; pointer-events: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* HUD基本 */
        #battle-counter-area { position: fixed; top: 25px; left: 50%; transform: translateX(-50%); z-index: 80; text-align: center; font-family: 'Orbitron', sans-serif !important; pointer-events: none; transition: 0.3s; }
        body.pro-mode #battle-counter-area { top: 15px; }
        .battle-ordinal { font-size: 32px; font-weight: 900; color: var(--bx-yellow); text-shadow: 0 0 15px rgba(255, 242, 0, 0.6), 2px 2px 0 black; margin-right: 5px; }
        .battle-label { font-size: 20px; font-weight: 900; color: white; text-shadow: 1px 1px 0 black; }
        
        #tournament-title-area { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 80; display: flex; flex-direction: column; align-items: center; width: 60%; transition: 0.3s; pointer-events: none; }
        .tournament-input { font-family: 'Chakra Petch', sans-serif !important; font-size: 16px; font-weight: 700; font-style: italic; color: rgba(255, 255, 255, 0.6); text-shadow: 2px 2px 2px black; background: transparent; border: none; text-align: center; width: 100%; outline: none; line-height: 1.2; pointer-events: auto; }

        .player-wrapper { position: fixed; top: 75px; z-index: 50; display: flex; flex-direction: column; gap: 2px; transition: top 0.4s; }
        body.pro-mode .player-wrapper { top: 15px; }
        #p1-wrapper { left: max(20px, calc(var(--safe-left) + 20px)); align-items: flex-start; }
        #p2-wrapper { right: max(20px, calc(var(--safe-right) + 20px)); align-items: flex-end; }
        
        .name-input { 
            font-family: 'Chakra Petch', sans-serif !important; 
            font-size: 24px; font-style: italic; font-weight: bold; 
            color: var(--bx-green); text-shadow: 2px 2px 0px black; 
            background: transparent; border: none; border-bottom: 2px solid var(--bx-green); 
            width: auto; min-width: 100px; max-width: 250px; 
            field-sizing: content; outline: none; margin-bottom: 2px; 
        }
        
        .score { 
            font-family: 'DSEG7 Classic', sans-serif !important; 
            font-weight: bold; font-style: italic; font-size: 85px; 
            line-height: 1; color: white; 
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 3px 3px 0px black; 
            cursor: default; margin: 0; min-width: 60px; text-align: center; 
        }
        
        .hud-btn { 
            font-family: 'Orbitron', sans-serif !important; 
            font-weight: 900; font-size: 18px; width: 40px; height: 40px; 
            border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); 
            background: rgba(0,0,0,0.5); color: white; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
        }

        #win-display { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); width: 100%; text-align: center; font-family: 'Orbitron', sans-serif; font-weight: 900; color: #fff000; opacity: 0; transition: 0.3s; z-index: 70; pointer-events: none; }
        .show-win { opacity: 1 !important; transform: translate(-50%, -50%) scale(1.05) !important; }
        
        #effect-overlay { position: fixed; top: 0; left: 0; z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; pointer-events: none; }
        #effect-text { 
            font-family: 'Orbitron', sans-serif; 
            font-weight: 900; font-style: italic; 
            color: white; text-shadow: 0 0 20px var(--bx-green), 4px 4px 0px black; 
            width: 90%; text-align: center; opacity: 1; 
            transition: opacity 0.5s ease-out; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; 
        }
        
        /* 決まり手演出用 */
        .effect-finish-style { font-family: 'Orbitron', sans-serif !important; font-size: 18vmin !important; }
        .timer-style { font-family: 'DSEG7 Classic', sans-serif !important; font-size: 40vmin !important; }
        .interstitial-style { font-family: 'Orbitron', sans-serif !important; font-size: 10vmin !important; line-height: 1.1; }
        .interstitial-huge { font-size: 20vmin; display: block; font-weight: 900; color: var(--bx-yellow); }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="camera-bg" autoplay playsinline muted></video>
        <video id="replay-video" playsinline muted preload="auto"></video>
    </div>
    
    <div class="scan-line"></div>
    <div id="effect-overlay"><div id="effect-text"></div></div>
    <div id="replay-indicator">● REPLAY</div>
    <div id="replay-status">▶ 1.0</div>
    
    <div id="main-hud">
        <div id="battle-counter-area"><span id="battle-ordinal" class="battle-ordinal">1st</span><span class="battle-label">BATTLE</span></div>
        <div id="tournament-title-area">
            <input type="text" id="tournament-name-1" class="tournament-input" value="ITABASHI">
            <input type="text" id="tournament-name-2" class="tournament-input" value="BEY BATTLE">
        </div>

        <div id="p1-wrapper" class="player-wrapper">
            <input type="text" id="name1" class="name-input" value="BLADER 1">
            <div style="display:flex; align-items:flex-start; gap:10px; flex-direction:row-reverse;">
                <div id="score1" class="score">0</div>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:5px;">
                    <div class="hud-btn" onclick="addScore(1, 3, 'XTREME')" style="border-color:var(--bx-red); color:var(--bx-red);">X</div>
                    <div class="hud-btn" onclick="addScore(1, 2, 'BURST')" style="border-color:var(--bx-red-orange); color:var(--bx-red-orange);">B</div>
                    <div class="hud-btn" onclick="addScore(1, 2, 'OVER')" style="border-color:var(--bx-orange); color:var(--bx-orange);">O</div>
                    <div class="hud-btn" onclick="addScore(1, 1, 'SPIN')" style="border-color:var(--bx-blue); color:var(--bx-blue);">S</div>
                </div>
            </div>
        </div>

        <div id="p2-wrapper" class="player-wrapper">
            <input type="text" id="name2" class="name-input" value="BLADER 2">
            <div style="display:flex; align-items:flex-start; gap:10px;">
                <div id="score2" class="score">0</div>
                <div style="display:flex; flex-direction:column; gap:6px; margin-top:5px;">
                    <div class="hud-btn" onclick="addScore(2, 3, 'XTREME')" style="border-color:var(--bx-red); color:var(--bx-red);">X</div>
                    <div class="hud-btn" onclick="addScore(2, 2, 'BURST')" style="border-color:var(--bx-red-orange); color:var(--bx-red-orange);">B</div>
                    <div class="hud-btn" onclick="addScore(2, 2, 'OVER')" style="border-color:var(--bx-orange); color:var(--bx-orange);">O</div>
                    <div class="hud-btn" onclick="addScore(2, 1, 'SPIN')" style="border-color:var(--bx-blue); color:var(--bx-blue);">S</div>
                </div>
            </div>
        </div>
    </div>

    <div id="win-display"></div>

    <button class="system-btn btn-reset" onclick="resetGame()">R</button>
    <button class="system-btn btn-timer-toggle" onclick="toggleTimerDuration()" id="btn-timer-toggle">10</button>
    <button class="system-btn btn-timer" onclick="toggleTimer()">T</button>
    <button class="system-btn btn-bg" onclick="toggleBackground()">B</button>
    <button class="system-btn btn-rotate" onclick="rotateCamera()">180</button>
    <button class="system-btn btn-mic" onclick="toggleMic()" id="btn-mic">M</button>
    <button class="system-btn btn-winpoint" onclick="toggleWinPoint()" id="btn-winpoint">4</button>

    <script>
        let s1 = 0, s2 = 0, winScoreLimit = 4, battleCount = 1, timerDuration = 10;
        let isFinished = false, isCountingDown = false, timerInterval = null;
        let isReplayMode = false, currentStream = null, mediaRecorder = null;
        let chunks = [], effectTimeout = null, cleanupTimeout = null, statusMsgTimeout = null;

        // ズーム・移動状態変数
        let currentScale = 1, currentTranslateX = 0, currentTranslateY = 0, currentRotation = 0;
        let startDist = 0, initialScale = 1, startX = 0, startY = 0, initialTX = 0, initialTY = 0;

        const camVideo = document.getElementById('camera-bg');
        const replayVideo = document.getElementById('replay-video');
        const replayLabel = document.getElementById('replay-indicator');
        const replayStatus = document.getElementById('replay-status');
        const hud = document.getElementById('main-hud');

        function applyTransforms() {
            const transformStr = `rotate(${currentRotation}deg) scale(${currentScale}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
            camVideo.style.transform = transformStr;
            replayVideo.style.transform = transformStr;
        }

        document.body.addEventListener('touchstart', e => {
            if (e.target.closest('.system-btn') || e.target.closest('.hud-btn') || e.target.tagName === 'INPUT') return;
            if (e.touches.length === 2) {
                startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                initialScale = currentScale;
            } else if (e.touches.length === 1) {
                startX = e.touches[0].pageX; startY = e.touches[0].pageY;
                initialTX = currentTranslateX; initialTY = currentTranslateY;
            }
        }, { passive: false });

        document.body.addEventListener('touchmove', e => {
            if (e.target.closest('.system-btn') || e.target.closest('.hud-btn') || e.target.tagName === 'INPUT') return;
            e.preventDefault();
            if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                currentScale = Math.min(Math.max(initialScale * (dist / startDist), 1), 5);
                applyTransforms();
            } else if (e.touches.length === 1 && currentScale > 1) {
                currentTranslateX = initialTX + (e.touches[0].pageX - startX) / currentScale;
                currentTranslateY = initialTY + (e.touches[0].pageY - startY) / currentScale;
                applyTransforms();
            }
        }, { passive: false });

        async function initMedia(withMic = false) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: withMic
                });
                camVideo.srcObject = currentStream;
                camVideo.muted = !withMic;
                startBuffering(currentStream);
            } catch (err) { console.error(err); }
        }

        function startBuffering(stream) {
            if (mediaRecorder) try { mediaRecorder.stop(); } catch(e){}
            const mime = MediaRecorder.isTypeSupported('video/mp4; codecs=avc1') ? 'video/mp4; codecs=avc1' : 'video/mp4';
            mediaRecorder = new MediaRecorder(stream, { mimeType: mime });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.start(1000); 
            setInterval(() => { if (!isReplayMode && chunks.length > 20) { mediaRecorder.stop(); setTimeout(() => { chunks = []; mediaRecorder.start(1000); }, 10); } }, 20000);
        }

        async function toggleReplayMode() {
            if (!isReplayMode) {
                isReplayMode = true;
                const blob = new Blob(chunks, { type: 'video/mp4' });
                replayVideo.src = URL.createObjectURL(blob);
                replayVideo.style.display = 'block'; replayLabel.style.display = 'block'; replayStatus.style.display = 'block'; hud.style.display = 'none';
                replayStatus.innerText = "▶ 1.0";
                replayVideo.load();
                replayVideo.oncanplay = () => { replayVideo.currentTime = Math.max(0, replayVideo.duration - 15); replayVideo.play(); };
            } else {
                isReplayMode = false; replayVideo.pause(); replayVideo.src = ""; replayVideo.style.display = 'none'; replayLabel.style.display = 'none'; replayStatus.style.display = 'none'; hud.style.display = 'block';
            }
        }

        function rotateCamera() { currentRotation = (currentRotation === 0) ? 180 : 0; applyTransforms(); }

        function addScore(p, pts, t) {
            if (isFinished || isReplayMode) return;
            let styles = {SPIN:'ef-spin', OVER:'ef-over', BURST:'ef-burst', XTREME:'ef-xtreme'};
            showOverlayText(t + "<br>FINISH", 'effect-finish-style ' + styles[t], 2000);
            if (p === 1) s1 = Math.min(s1 + pts, winScoreLimit); else s2 = Math.min(s2 + pts, winScoreLimit);
            document.getElementById('score1').innerText = s1; document.getElementById('score2').innerText = s2;
            if (s1 >= winScoreLimit || s2 >= winScoreLimit) { isFinished = true; setTimeout(() => finishGame(p), 2500); }
            else { setTimeout(() => { battleCount++; updateBattleCounterDisplay(); let suffix = ["st","nd","rd"][battleCount-1] || "th"; let nextText = ( (s1 === winScoreLimit - 1 && s2 === winScoreLimit - 1) || battleCount >= 7 ) ? "FINAL" : `${battleCount}${suffix}`; showOverlayText(`NEXT to<br><span class="interstitial-huge">${nextText}</span>BATTLE`, 'interstitial-style', 2500); }, 2500); }
        }

        window.addEventListener('keydown', e => {
            if (document.activeElement.tagName === 'INPUT') return;
            const key = e.key;
            if (key === 'Tab') { e.preventDefault(); toggleReplayMode(); return; }
            if (isReplayMode) {
                if (key === '5') { if (replayVideo.paused) replayVideo.play(); else replayVideo.pause(); replayStatus.innerText = replayVideo.paused ? "‖ STOP" : "▶ 1.0"; }
                if (key === '6') { replayVideo.playbackRate = 0.1; replayVideo.play(); replayStatus.innerText = "▶ 0.1"; }
                if (key === '4') { replayVideo.currentTime = Math.max(0, replayVideo.currentTime - 5); replayVideo.play(); }
                if (key === 'Enter') { replayVideo.currentTime = Math.max(0, replayVideo.duration - 15); replayVideo.play(); }
            } else {
                if (key === 'Backspace') document.body.classList.toggle('pro-mode');
                if (key === '/') resetGame();
                if (key === '7') addScore(1, 3, 'XTREME'); if (key === '4') addScore(1, 2, 'BURST'); if (key === '1') addScore(1, 2, 'OVER'); if (key === '0') addScore(1, 1, 'SPIN');
                if (key === '9') addScore(2, 3, 'XTREME'); if (key === '6') addScore(2, 2, 'BURST'); if (key === '3') addScore(2, 2, 'OVER'); if (key === '.') addScore(2, 1, 'SPIN');
                if (key === '8') { s1 = Math.max(0, s1-1); document.getElementById('score1').innerText = s1; }
                if (key === '2') { s2 = Math.max(0, s2-1); document.getElementById('score2').innerText = s2; }
            }
        });

        function resetGame() { s1 = 0; s2 = 0; battleCount = 1; isFinished = false; document.getElementById('score1').innerText = 0; document.getElementById('score2').innerText = 0; updateBattleCounterDisplay(); showIntro(); }
        
        function showOverlayText(h, s, d) { 
            const o = document.getElementById('effect-overlay'), t = document.getElementById('effect-text'); 
            t.className = s; t.innerHTML = h; o.style.display = 'flex'; 
            if (d > 0) setTimeout(() => o.style.display = 'none', d); 
        }

        function showIntro() {
            document.getElementById('battle-counter-area').style.opacity = '0';
            document.getElementById('tournament-title-area').style.opacity = '0';
            showOverlayText(`<span style="color:var(--bx-yellow)">${document.getElementById('tournament-name-1').value}</span><br><span style="color:var(--bx-yellow)">${document.getElementById('tournament-name-2').value}</span><br><br><span style="color:var(--bx-red)">Ready......</span>`, 'interstitial-style', 4000); 
            setTimeout(() => { document.getElementById('battle-counter-area').style.opacity = '1'; document.getElementById('tournament-title-area').style.opacity = '1'; }, 4500);
        }

        function updateBattleCounterDisplay() {
            let suffix = ["st","nd","rd"][battleCount-1] || "th";
            let text = ( (s1 === winScoreLimit - 1 && s2 === winScoreLimit - 1) || battleCount >= 7 ) ? "FINAL" : `${battleCount}${suffix}`;
            document.getElementById('battle-ordinal').innerText = text;
        }

        function finishGame(p) { const w = document.getElementById('win-display'); w.innerHTML = `<span style="font-size:15vmin;display:block;">${document.getElementById('name'+p).value}</span><span style="font-size:15vmin;display:block;color:white;">WIN</span>`; w.classList.add('show-win'); }
        function toggleMic() { const b = document.getElementById('btn-mic'); b.classList.toggle('active'); initMedia(b.classList.contains('active')); }
        function toggleWinPoint() { winScoreLimit = (winScoreLimit === 4 ? 2 : 4); document.getElementById('btn-winpoint').innerText = winScoreLimit; updateBattleCounterDisplay(); }
        function toggleTimerDuration() { timerDuration = (timerDuration === 10 ? 3 : 10); document.getElementById('btn-timer-toggle').innerText = timerDuration; }
        function toggleBackground() { document.body.classList.toggle('green-mode'); }
        function toggleTimer() { if (isCountingDown) { clearInterval(timerInterval); isCountingDown = false; document.getElementById('effect-overlay').style.display = 'none'; } else startTimer(); }
        function startTimer() {
            isCountingDown = true; showOverlayText("", 'timer-style', 0);
            let count = timerDuration; document.getElementById('effect-text').innerText = count;
            timerInterval = setInterval(() => { count--; if (count > 0) document.getElementById('effect-text').innerText = count; else { clearInterval(timerInterval); isCountingDown = false; document.getElementById('effect-text').innerText = "0"; setTimeout(() => document.getElementById('effect-overlay').style.display = 'none', 2000); } }, 1000);
        }

        initMedia();
    </script>
</body>
</html>