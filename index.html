<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ITABASHI BEYBLADE HUD - Ver.26.0 VAR</title>
    
    <style>
        /* ▼▼▼ フォント設定 ▼▼▼ */
        @font-face { font-family: 'DSEG7 Classic'; src: url('./font/DSEG7Classic-BoldItalic.ttf') format('truetype'); font-weight: bold; font-style: italic; }
        @font-face { font-family: 'Chakra Petch'; src: url('./font/ChakraPetch-BoldItalic.ttf') format('truetype'); font-weight: bold; font-style: italic; }
        @font-face { font-family: 'Orbitron'; src: url('./font/Orbitron-Black.ttf') format('truetype'); font-weight: 900; }

        :root {
            --bx-green: #b6ff00; --bx-blue: #00eaff; --bx-orange: #ffaa00;
            --bx-red-orange: #ff4500; --bx-red: #ff0055;
            --bx-yellow: #fff000;
            --safe-left: env(safe-area-inset-left); --safe-right: env(safe-area-inset-right);
        }

        body { 
            margin: 0; padding: 0; background: black; 
            font-family: 'Chakra Petch', sans-serif; overflow: hidden; color: white; 
            -webkit-tap-highlight-color: transparent; transition: background-color 0.3s;
        }

        body.green-mode { background-color: #00ff00 !important; }
        body.green-mode #camera-bg { display: none; }
        
        #camera-bg, #replay-video { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; transition: transform 0.5s; }
        #replay-video { z-index: 10; display: none; background: black; }
        .camera-rotate-180 { transform: rotate(180deg); }
        .scan-line { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 3px); pointer-events: none; }

        /* システムボタン */
        .system-btn { 
            position: fixed; z-index: 80; background: rgba(0,0,0,0.5); color: #aaa; border: 1px solid #555; 
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            font-size: 14px; font-weight: bold; cursor: pointer; font-family: 'Orbitron', sans-serif; border-radius: 8px; outline: none; transition: 0.3s;
        }
        .btn-reset { top: 20px; left: max(20px, calc(var(--safe-left) + 20px)); } 
        .btn-bg { bottom: 20px; left: max(20px, calc(var(--safe-left) + 20px)); }
        .btn-rotate { bottom: 20px; left: max(80px, calc(var(--safe-left) + 75px)); color: var(--bx-blue); border-color: var(--bx-blue); }
        .btn-mic { bottom: 20px; left: max(140px, calc(var(--safe-left) + 130px)); }
        .btn-mic.active { color: white; background: var(--bx-red); border-color: white; box-shadow: 0 0 10px var(--bx-red); }
        .btn-timer { top: 20px; right: max(20px, calc(var(--safe-right) + 20px)); } 
        .btn-timer-toggle { top: 20px; right: max(80px, calc(var(--safe-right) + 75px)); color: var(--bx-blue); }
        .btn-winpoint { bottom: 20px; right: max(20px, calc(var(--safe-right) + 20px)); color: var(--bx-orange); font-size: 18px; }

        body.pro-mode .system-btn { display: none !important; }

        /* リプレイUI */
        #replay-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; font-family: 'Orbitron', sans-serif; font-size: 40px; color: var(--bx-red); text-shadow: 0 0 20px var(--bx-red); font-weight: 900; font-style: italic; display: none; letter-spacing: 5px; animation: blink 1s infinite; }
        #replay-status { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; font-family: 'Orbitron', sans-serif; font-size: 28px; font-weight: 900; background: rgba(0, 0, 0, 0.7); padding: 10px 30px; border-radius: 50px; border: 2px solid var(--bx-red); color: white; display: none; box-shadow: 0 0 20px rgba(255, 0, 85, 0.3); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* HUD基本配置 */
        #battle-counter-area { position: fixed; top: 25px; left: 50%; transform: translateX(-50%); z-index: 80; text-align: center; font-family: 'Orbitron', sans-serif; pointer-events: none; transition: 0.3s; }
        body.pro-mode #battle-counter-area { top: 15px; }
        .battle-ordinal { font-size: 32px; font-weight: 900; color: var(--bx-yellow); text-shadow: 0 0 15px rgba(255, 242, 0, 0.6), 2px 2px 0 black; margin-right: 5px; }
        .battle-label { font-size: 20px; font-weight: 700; color: white; text-shadow: 1px 1px 0 black; }
        #tournament-title-area { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 80; display: flex; flex-direction: column; align-items: center; width: 40%; transition: 0.3s; }
        .tournament-input { font-family: 'Chakra Petch', sans-serif; font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.5); text-shadow: 1px 1px 1px black; background: transparent; border: none; text-align: center; width: 100%; outline: none; line-height: 1.2; }

        /* プレイヤーエリア */
        .player-wrapper { position: fixed; top: 75px; z-index: 50; display: flex; flex-direction: column; gap: 2px; transition: top 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        body.pro-mode .player-wrapper { top: 15px; }
        #p1-wrapper { left: max(20px, calc(var(--safe-left) + 20px)); align-items: flex-start; }
        #p2-wrapper { right: max(20px, calc(var(--safe-right) + 20px)); align-items: flex-end; }
        .name-input { font-family: 'Chakra Petch', sans-serif; font-size: 24px; font-style: italic; font-weight: bold; color: var(--bx-green); text-shadow: 2px 2px 0px black; background: transparent; border: none; border-bottom: 2px solid var(--bx-green); width: auto; min-width: 100px; max-width: 250px; field-sizing: content; outline: none; margin-bottom: 2px; }
        .stats-row { display: flex; align-items: flex-start; gap: 10px; }
        #p1-wrapper .stats-row { flex-direction: row-reverse; }
        .score { font-family: 'DSEG7 Classic', sans-serif; font-weight: bold; font-style: italic; font-size: 85px; line-height: 1; color: white; text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 3px 3px 0px black; cursor: default; margin: 0; min-width: 60px; text-align: center; }
        .buttons-col { display: flex; flex-direction: column; gap: 6px; margin-top: 5px; }
        .hud-btn { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 18px; width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5); color: white; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; padding: 0; }
        .active-history { color: black !important; border-color: white !important; text-shadow: none !important; }
        .btn-xtreme.active-history { background: var(--bx-red) !important; box-shadow: 0 0 15px var(--bx-red); }
        .btn-burst.active-history { background: var(--bx-red-orange) !important; box-shadow: 0 0 15px var(--bx-red-orange); }
        .btn-over.active-history { background: var(--bx-orange) !important; box-shadow: 0 0 15px var(--bx-orange); }
        .btn-spin.active-history { background: var(--bx-blue) !important; box-shadow: 0 0 15px var(--bx-blue); }

        /* 演出系 */
        #win-display { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); width: 100%; text-align: center; font-family: 'Orbitron', sans-serif; font-weight: 900; font-style: italic; color: #fff000; text-shadow: 5px 5px 0px #000, 0 0 50px #fff000; opacity: 0; transition: 0.3s; z-index: 70; pointer-events: none; white-space: nowrap; }
        .show-win { opacity: 1 !important; transform: translate(-50%, -50%) scale(1.05) !important; animation: glowing-win-anim 0.8s infinite alternate ease-in-out; }
        #effect-overlay { position: fixed; top: 0; left: 0; z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; pointer-events: none; }
        #effect-text { font-family: 'DSEG7 Classic', sans-serif; font-weight: bold; font-style: italic; color: white; text-shadow: 0 0 20px var(--bx-green), 4px 4px 0px black; width: 90%; text-align: center; opacity: 1; transition: opacity 0.5s ease-out; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .fade-out { opacity: 0 !important; }
        .timer-style { font-size: 40vmin !important; color: white; text-shadow: 0 0 30px rgba(255,255,255,0.8), 5px 5px 0 black; }
        .ef-time-up { color: var(--bx-red) !important; text-shadow: 0 0 40px var(--bx-red), 4px 4px 0px black !important; font-size: 40vmin !important; }
        .effect-finish-style { font-family: 'Orbitron', sans-serif !important; font-size: 18vmin !important; line-height: 1.0 !important; transform: scale(1.1); white-space: pre-wrap; }
        .interstitial-style { font-family: 'Orbitron', sans-serif !important; font-size: 12vmin !important; line-height: 1.1 !important; color: white !important; text-shadow: 0 0 20px rgba(255,255,255,0.5), 4px 4px 0 black !important; }
        .interstitial-huge { font-size: 25vmin; display: block; font-weight: 900; color: var(--bx-yellow); text-shadow: 0 0 20px var(--bx-yellow), 4px 4px 0 black; line-height: 0.9; }
    </style>
</head>
<body>
    <video id="camera-bg" autoplay playsinline muted></video>
    <video id="replay-video" playsinline></video>
    <div class="scan-line"></div>
    <div id="effect-overlay"><div id="effect-text"></div></div>
    
    <div id="replay-indicator">● REPLAY</div>
    <div id="replay-status">▶ 1.0</div>
    
    <div id="main-hud">
        <div id="battle-counter-area"><span id="battle-ordinal" class="battle-ordinal">1st</span><span class="battle-label">BATTLE</span></div>
        <div id="tournament-title-area">
            <input type="text" id="tournament-name-1" class="tournament-input" value="ITABASHI">
            <input type="text" id="tournament-name-2" class="tournament-input" value="BEY BATTLE">
        </div>

        <div id="p1-wrapper" class="player-wrapper">
            <input type="text" id="name1" class="name-input" value="BLADER 1">
            <div class="stats-row">
                <div id="score1" class="score">0</div>
                <div class="buttons-col">
                    <div id="p1-btn-xtreme" class="hud-btn btn-xtreme" onclick="addScore(1, 3, 'XTREME')">X</div>
                    <div id="p1-btn-burst" class="hud-btn btn-burst" onclick="addScore(1, 2, 'BURST')">B</div>
                    <div id="p1-btn-over" class="hud-btn btn-over" onclick="addScore(1, 2, 'OVER')">O</div>
                    <div id="p1-btn-spin" class="hud-btn btn-spin" onclick="addScore(1, 1, 'SPIN')">S</div>
                </div>
            </div>
        </div>

        <div id="p2-wrapper" class="player-wrapper">
            <input type="text" id="name2" class="name-input" value="BLADER 2">
            <div class="stats-row">
                <div id="score2" class="score">0</div>
                <div class="buttons-col">
                    <div id="p2-btn-xtreme" class="hud-btn btn-xtreme" onclick="addScore(2, 3, 'XTREME')">X</div>
                    <div id="p2-btn-burst" class="hud-btn btn-burst" onclick="addScore(2, 2, 'BURST')">B</div>
                    <div id="p2-btn-over" class="hud-btn btn-over" onclick="addScore(2, 2, 'OVER')">O</div>
                    <div id="p2-btn-spin" class="hud-btn btn-spin" onclick="addScore(2, 1, 'SPIN')">S</div>
                </div>
            </div>
        </div>
    </div>

    <div id="win-display"></div>

    <button class="system-btn btn-reset" onclick="resetGame()">R</button>
    <button class="system-btn btn-timer-toggle" onclick="toggleTimerDuration()" id="btn-timer-toggle">10</button>
    <button class="system-btn btn-timer" onclick="toggleTimer()">T</button>
    <button class="system-btn btn-bg" onclick="toggleBackground()">B</button>
    <button class="system-btn btn-rotate" onclick="rotateCamera()">180</button>
    <button class="system-btn btn-mic" onclick="toggleMic()" id="btn-mic">M</button>
    <button class="system-btn btn-winpoint" onclick="toggleWinPoint()" id="btn-winpoint">4</button>

    <script>
        let s1 = 0, s2 = 0, winScoreLimit = 4, battleCount = 1, timerDuration = 10;
        let isFinished = false, isCountingDown = false, timerInterval = null;
        let isReplayMode = false, mediaRecorder, chunks = [], currentStream = null;
        let effectTimeout = null, cleanupTimeout = null, reverseMsgTimeout = null;

        const camVideo = document.getElementById('camera-bg');
        const replayVideo = document.getElementById('replay-video');
        const replayLabel = document.getElementById('replay-indicator');
        const replayStatus = document.getElementById('replay-status');
        const hud = document.getElementById('main-hud');

        async function initMedia(withMic = false) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: withMic
                });
                camVideo.srcObject = currentStream;
                camVideo.muted = !withMic;
                startBuffering(currentStream);
            } catch (err) { console.error(err); }
        }

        function startBuffering(stream) {
            if (mediaRecorder) try { mediaRecorder.stop(); } catch(e){}
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.start(1000);
            // ★バッファを15秒に制限（メモリ安定化）
            setInterval(() => { if (chunks.length > 20) chunks.shift(); }, 1000);
        }

        function showOverlayText(htmlContent, styleClass, displayTime = 0) {
            const overlay = document.getElementById('effect-overlay'), textEl = document.getElementById('effect-text');
            clearTimeout(effectTimeout); clearTimeout(cleanupTimeout);
            textEl.className = styleClass; textEl.innerHTML = htmlContent;
            overlay.style.display = 'flex'; textEl.classList.remove('fade-out');
            if (displayTime > 0) {
                effectTimeout = setTimeout(() => {
                    textEl.classList.add('fade-out');
                    cleanupTimeout = setTimeout(() => { overlay.style.display = 'none'; }, 500);
                }, displayTime);
            }
        }

        function updateBattleCounterDisplay() {
            let suffix = ["st","nd","rd"][battleCount-1] || "th";
            let text = ( (s1 === winScoreLimit - 1 && s2 === winScoreLimit - 1) || battleCount >= 7 ) ? "FINAL" : `${battleCount}${suffix}`;
            document.getElementById('battle-ordinal').innerText = text;
        }

        function addScore(player, pts, type) {
            if (isFinished || isReplayMode) return;
            if (isCountingDown) stopTimer();
            let styles = {SPIN:'ef-spin', OVER:'ef-over', BURST:'ef-burst', XTREME:'ef-xtreme'};
            showOverlayText(type + "<br>FINISH", 'effect-finish-style ' + styles[type], 2000);
            document.getElementById(`p${player}-btn-${type.toLowerCase()}`).classList.add('active-history');
            if (player === 1) { s1 = Math.min(s1 + pts, winScoreLimit); document.getElementById('score1').innerText = s1; }
            else { s2 = Math.min(s2 + pts, winScoreLimit); document.getElementById('score2').innerText = s2; }

            if (s1 >= winScoreLimit || s2 >= winScoreLimit) {
                isFinished = true; setTimeout(() => {
                    const winLabel = document.getElementById('win-display');
                    winLabel.innerHTML = `<span style="font-size:15vmin;display:block;">${document.getElementById('name'+player).value}</span><span style="font-size:15vmin;display:block;color:white;">WIN</span>`;
                    winLabel.classList.add('show-win');
                    document.getElementById('score'+player).style.color = "#fff000";
                }, 2500);
            } else {
                setTimeout(() => {
                    battleCount++; updateBattleCounterDisplay();
                    let suffix = ["st","nd","rd"][battleCount-1] || "th";
                    let nextText = ( (s1 === winScoreLimit - 1 && s2 === winScoreLimit - 1) || battleCount >= 7 ) ? "FINAL" : `${battleCount}${suffix}`;
                    showOverlayText(`NEXT to<br><span class="interstitial-huge">${nextText}</span>BATTLE`, 'interstitial-style', 2500);
                }, 2500);
            }
        }

        function resetGame() {
            s1 = 0; s2 = 0; battleCount = 1; isFinished = false; stopTimer();
            document.getElementById('score1').innerText = 0; document.getElementById('score2').innerText = 0;
            document.getElementById('score1').style.color = "white"; document.getElementById('score2').style.color = "white";
            document.getElementById('win-display').classList.remove('show-win');
            document.querySelectorAll('.active-history').forEach(b => b.classList.remove('active-history'));
            updateBattleCounterDisplay();
            document.getElementById('battle-counter-area').style.opacity = '0';
            document.getElementById('tournament-title-area').style.opacity = '0';
            showOverlayText(`<span style="color:var(--bx-yellow)">${document.getElementById('tournament-name-1').value}</span><br><span style="color:var(--bx-yellow)">${document.getElementById('tournament-name-2').value}</span><br><br><span style="color:var(--bx-red)">Ready......</span>`, 'interstitial-style', 4000); 
            setTimeout(() => { document.getElementById('battle-counter-area').style.opacity = '1'; document.getElementById('tournament-title-area').style.opacity = '1'; }, 4500);
        }

        function toggleTimer() { if (isCountingDown) stopTimer(); else startTimer(); }
        function startTimer() {
            isCountingDown = true; showOverlayText("", 'timer-style', 0);
            let count = timerDuration; document.getElementById('effect-text').innerText = count;
            timerInterval = setInterval(() => {
                count--; if (count > 0) document.getElementById('effect-text').innerText = count;
                else { clearInterval(timerInterval); isCountingDown = false; document.getElementById('effect-text').innerText = "0"; document.getElementById('effect-text').className = 'timer-style ef-time-up'; setTimeout(() => { document.getElementById('effect-overlay').style.display = 'none'; }, 2000); }
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); isCountingDown = false; document.getElementById('effect-overlay').style.display = 'none'; }

        // --- リプレイ機能（Ver.26.0版） ---
        async function toggleReplayMode() {
            isReplayMode = !isReplayMode;
            if (isReplayMode) {
                const blob = new Blob(chunks, { type: 'video/webm' });
                replayVideo.src = URL.createObjectURL(blob);
                replayVideo.style.display = 'block'; replayLabel.style.display = 'block'; replayStatus.style.display = 'block';
                hud.style.display = 'none'; replayStatus.innerText = "▶ 1.0";
                replayVideo.onloadedmetadata = () => {
                    // ★15秒前から再生
                    replayVideo.currentTime = Math.max(0, replayVideo.duration - 15);
                    replayVideo.playbackRate = 1.0; replayVideo.play();
                };
            } else {
                replayVideo.pause(); replayVideo.style.display = 'none';
                replayLabel.style.display = 'none'; replayStatus.style.display = 'none'; hud.style.display = 'block';
            }
        }

        function updateStatusMsg(msg, duration = 0) {
            clearTimeout(reverseMsgTimeout);
            replayStatus.innerText = msg;
            if (duration > 0) {
                reverseMsgTimeout = setTimeout(() => {
                    // 現在の実際の状態に戻す
                    replayStatus.innerText = replayVideo.paused ? "‖ STOP" : `▶ ${replayVideo.playbackRate}`;
                }, duration);
            }
        }

        function blurFocus() { if (document.activeElement instanceof HTMLElement) document.activeElement.blur(); }
        function toggleBackground() { blurFocus(); document.body.classList.toggle('green-mode'); }
        function rotateCamera() { blurFocus(); camVideo.classList.toggle('camera-rotate-180'); replayVideo.classList.toggle('camera-rotate-180'); }
        function toggleWinPoint() { blurFocus(); winScoreLimit = (winScoreLimit === 4 ? 2 : 4); document.getElementById('btn-winpoint').innerText = winScoreLimit; updateBattleCounterDisplay(); }
        function toggleTimerDuration() { blurFocus(); timerDuration = (timerDuration === 10 ? 3 : 10); document.getElementById('btn-timer-toggle').innerText = timerDuration; }
        function toggleMic() { const b = document.getElementById('btn-mic'); b.classList.toggle('active'); initMedia(b.classList.contains('active')); }

        window.addEventListener('keydown', e => {
            if (document.activeElement.tagName === 'INPUT') return;
            const key = e.key;

            // ★TABでリプレイ切替
            if (key === 'Tab') { e.preventDefault(); toggleReplayMode(); return; }

            if (isReplayMode) {
                // 5: 再生/停止トグル
                if (key === '5') {
                    if (replayVideo.paused) { replayVideo.playbackRate = 1.0; replayVideo.play(); updateStatusMsg("▶ 1.0"); }
                    else { replayVideo.pause(); updateStatusMsg("‖ STOP"); }
                }
                // 6: 0.25倍速
                if (key === '6') { replayVideo.playbackRate = 0.25; replayVideo.play(); updateStatusMsg("▶ 0.25"); }
                // 4: 5秒巻き戻し
                if (key === '4') {
                    replayVideo.currentTime = Math.max(0, replayVideo.currentTime - 5);
                    replayVideo.play();
                    updateStatusMsg("◀ REVERSE", 1000);
                }
                // Enter: 冒頭に戻る
                if (key === 'Enter') { replayVideo.currentTime = Math.max(0, replayVideo.duration - 15); replayVideo.playbackRate = 1.0; replayVideo.play(); updateStatusMsg("▶ 1.0"); }
            } else {
                if (key === 'Backspace') { e.preventDefault(); document.body.classList.toggle('pro-mode'); }
                if (key === 'Enter') { e.preventDefault(); toggleTimer(); }
                if (key === '/') resetGame();
                if (key === '7') addScore(1, 3, 'XTREME'); if (key === '4') addScore(1, 2, 'BURST');
                if (key === '1') addScore(1, 2, 'OVER'); if (key === '0') addScore(1, 1, 'SPIN');
                if (key === '9') addScore(2, 3, 'XTREME'); if (key === '6') addScore(2, 2, 'BURST');
                if (key === '3') addScore(2, 2, 'OVER'); if (key === '.') addScore(2, 1, 'SPIN');
                if (key === '8') { s1 = Math.max(0, s1-1); document.getElementById('score1').innerText = s1; }
                if (key === '2') { s2 = Math.max(0, s2-1); document.getElementById('score2').innerText = s2; }
            }
        });

        initMedia();
    </script>
</body>
</html>