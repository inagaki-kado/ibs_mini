<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ITABASHI BEYBLADE HUD - Ver.21.0</title>
    
    <style>
        /* ▼▼▼ フォント設定 ▼▼▼ */
        @font-face {
            font-family: 'DSEG7 Classic';
            src: url('./font/DSEG7Classic-BoldItalic.ttf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }
        @font-face {
            font-family: 'Chakra Petch';
            src: url('./font/ChakraPetch-BoldItalic.ttf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }
        @font-face {
            font-family: 'Orbitron';
            src: url('./font/Orbitron-Black.ttf') format('truetype');
            font-weight: 900;
        }

        :root {
            --bx-green: #b6ff00; --bx-blue: #00eaff; --bx-orange: #ffaa00;
            --bx-red-orange: #ff4500; --bx-red: #ff0055;
            --bx-yellow: #fff000;
            
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }

        body { 
            margin: 0; padding: 0; 
            background: black; 
            font-family: 'Chakra Petch', sans-serif; overflow: hidden; color: white; 
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s;
        }

        body.green-mode { background-color: #00ff00 !important; }
        body.green-mode #camera-bg { display: none; }
        
        #camera-bg { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; z-index: 1; 
            transition: transform 0.5s; 
        }
        .camera-rotate-180 { transform: rotate(180deg); }

        .scan-line { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2; 
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.03) 3px); 
            pointer-events: none; 
        }

        /* システムボタン（共通設定） */
        .system-btn { 
            position: fixed; z-index: 80;
            background: rgba(0,0,0,0.5); color: #aaa; border: 1px solid #555; 
            width: 45px; height: 45px; 
            display: flex; justify-content: center; align-items: center;
            font-size: 14px; font-weight: bold; cursor: pointer; 
            font-family: 'Orbitron', sans-serif; transition: 0.3s; border-radius: 8px;
            outline: none;
        }
        .system-btn:hover { color: var(--bx-green); border-color: var(--bx-green); background: rgba(0,0,0,0.7); }
        .system-btn:active { background: #333; transform: scale(0.95); }

        /* 左側のシステムボタン */
        .btn-reset { top: 20px; left: max(20px, calc(var(--safe-left) + 20px)); } 
        .btn-bg { bottom: 20px; left: max(20px, calc(var(--safe-left) + 20px)); }
        .btn-fullscreen { bottom: 20px; left: max(80px, calc(var(--safe-left) + 75px)); }
        .btn-rotate { bottom: 20px; left: max(140px, calc(var(--safe-left) + 130px)); color: var(--bx-blue); border-color: var(--bx-blue); }

        /* 右側のシステムボタン */
        .btn-timer { top: 20px; right: max(20px, calc(var(--safe-right) + 20px)); } 
        .btn-timer-toggle { top: 20px; right: max(80px, calc(var(--safe-right) + 75px)); color: var(--bx-blue); border-color: var(--bx-blue); }
        .btn-winpoint { bottom: 20px; right: max(20px, calc(var(--safe-right) + 20px)); color: var(--bx-orange); border-color: var(--bx-orange); font-size: 18px; }

        /* ▼▼▼ バトル数表示（修正：大きく・斜体解除） ▼▼▼ */
        #battle-counter-area {
            position: fixed; top: 25px; left: 50%; transform: translateX(-50%); z-index: 80;
            text-align: center; font-family: 'Orbitron', sans-serif; pointer-events: none; 
        }
        .battle-ordinal {
            /* サイズを大きく、斜体を解除 */
            font-size: 32px; 
            font-weight: 900; color: var(--bx-yellow); 
            font-style: normal; /* 斜体解除 */
            text-shadow: 0 0 15px rgba(255, 242, 0, 0.6), 2px 2px 0 black;
            margin-right: 5px;
        }
        .battle-label {
            font-size: 20px; font-weight: 700; color: white; text-shadow: 1px 1px 0 black;
        }

        /* 大会名入力エリア */
        #tournament-title-area {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 80;
            display: flex; flex-direction: column; align-items: center; gap: 0px;
            width: 40%;
        }
        .tournament-input {
            font-family: 'Chakra Petch', sans-serif;
            font-size: 14px; font-weight: 500; font-style: normal; 
            color: rgba(255, 255, 255, 0.5); text-shadow: 1px 1px 1px black; 
            background: transparent; border: none; text-align: center; width: 100%; outline: none;
            padding: 0; margin: 0; line-height: 1.2; transition: 0.3s;
        }
        .tournament-input:hover, .tournament-input:focus {
            color: white; background: rgba(0,0,0,0.5);
        }

        /* ▼▼▼ プレイヤー情報エリア（一括管理） ▼▼▼ */
        .player-wrapper {
            position: fixed; top: 85px; /* ボタンの下に配置 */
            z-index: 50;
            display: flex; flex-direction: column; 
            gap: 5px;
        }

        /* 左側（P1） */
        #p1-wrapper { 
            left: max(20px, calc(var(--safe-left) + 20px)); 
            align-items: flex-start; 
        }
        
        /* 右側（P2） */
        #p2-wrapper { 
            right: max(20px, calc(var(--safe-right) + 20px)); 
            align-items: flex-end; 
        }

        /* 名前入力欄 */
        .name-input { 
            font-family: 'Chakra Petch', sans-serif;
            font-size: 24px; font-style: italic; font-weight: bold;
            color: var(--bx-green); text-shadow: 2px 2px 0px black; 
            background: transparent; border: none;
            border-bottom: 2px solid var(--bx-green);
            width: 220px; outline: none; margin-bottom: 5px;
        }
        #p1-wrapper .name-input { text-align: left; }
        #p2-wrapper .name-input { text-align: right; }

        /* スコアとボタンのコンテナ */
        .stats-row {
            display: flex; align-items: flex-start; gap: 10px;
        }
        /* P1: [ボタン] [スコア] の順 (row-reverse) -> 修正: ボタンは右、スコア左？いえ、「内側」なので */
        /* ブレーダー1(左側)は [スコア][ボタン] の順だとボタンが内側に来る */
        /* リクエスト：「ブレーダー1の得点は決まり手ボタンの右」＝ [ボタン] [スコア] */
        #p1-wrapper .stats-row { flex-direction: row-reverse; }

        /* リクエスト：「ブレーダー2の得点は決まり手ボタンの左」＝ [スコア] [ボタン] */
        #p2-wrapper .stats-row { flex-direction: row; }

        /* スコアボックス */
        .score-box { position: relative; }
        .score { 
            font-family: 'DSEG7 Classic', sans-serif; font-weight: bold; font-style: italic;
            font-size: 85px; 
            line-height: 1; color: white; 
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 3px 3px 0px black;
            cursor: default; margin: 0;
            min-width: 60px; text-align: center;
        }
        .undo-btn {
            position: absolute; bottom: -12px; 
            right: 50%; transform: translateX(50%);
            font-size: 12px; color: #777; background: rgba(0,0,0,0.8); 
            border: 1px solid #555; border-radius: 4px; 
            width: 40px; height: 20px; cursor: pointer; 
            font-family: 'Orbitron', sans-serif;
            display: flex; justify-content: center; align-items: center;
        }

        /* ▼▼▼ ボタン列（丸形に変更） ▼▼▼ */
        .buttons-col {
            display: flex; flex-direction: column; gap: 6px; 
            margin-top: 5px; /* 位置調整 */
        }

        .hud-btn {
            font-family: 'Orbitron', sans-serif; font-weight: 900; font-style: italic;
            font-size: 18px; 
            /* 正円にする設定 */
            width: 40px; height: 40px; 
            border-radius: 50%; 
            border: 2px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5);
            color: white; cursor: pointer; transition: 0.1s; 
            /* skew（斜め変形）を解除 */
            transform: none; 
            text-shadow: 1px 1px 2px black; user-select: none;
            display: flex; justify-content: center; align-items: center;
            padding: 0;
        }
        .hud-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        .hud-btn span { display: block; transform: none; } /* 中の文字の変形も解除 */

        .btn-xtreme { border-color: var(--bx-red); color: var(--bx-red); background: radial-gradient(circle, rgba(255,0,85,0.2), transparent); }
        .btn-burst { border-color: var(--bx-red-orange); color: var(--bx-red-orange); }
        .btn-over { border-color: var(--bx-orange); color: var(--bx-orange); }
        .btn-spin { border-color: var(--bx-blue); color: var(--bx-blue); }


        /* WIN表示 */
        #win-display {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.5); 
            width: 100%; text-align: center;
            font-family: 'Orbitron', sans-serif; 
            font-weight: 900; font-style: italic; 
            color: #fff000; 
            text-shadow: 5px 5px 0px #000, 0 0 50px #fff000;
            opacity: 0; transition: 0.3s; z-index: 70; pointer-events: none;
            white-space: nowrap; 
        }
        
        @keyframes glowing-win-anim {
            0%   { text-shadow: 0 0 20px #fff, 0 0 40px #fff000, 0 0 60px #fff000, 4px 4px 0 #000; }
            100% { text-shadow: 0 0 50px #fff, 0 0 100px #fff000, 0 0 150px #ffaa00, 4px 4px 0 #000; }
        }
        
        .show-win { 
            opacity: 1 !important; 
            transform: translate(-50%, -50%) scale(1.05) !important;
            animation: glowing-win-anim 0.8s infinite alternate ease-in-out;
        }
        
        .win-name { font-size: 15vmin; display: block; line-height: 1; }
        .win-label { font-size: 15vmin; display: block; margin-top: -0.15em; color: white; text-shadow: 0 0 30px white; line-height: 1; }

        /* エフェクト共通 */
        #effect-overlay {
            position: fixed; top: 0; left: 0; z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            width: 100vw; height: 100vh; pointer-events: none;
        }
        #effect-text {
            font-family: 'DSEG7 Classic', sans-serif; font-weight: bold; font-style: italic;
            color: white; text-shadow: 0 0 20px var(--bx-green), 4px 4px 0px black;
            width: 90%; text-align: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .fade-out { opacity: 0 !important; }

        /* タイマー */
        .timer-style {
            font-size: 40vmin !important; 
            color: white;
            text-shadow: 0 0 30px rgba(255,255,255,0.8), 5px 5px 0 black;
            animation: none !important;
        }
        .ef-time-up {
            color: var(--bx-red) !important; text-shadow: 0 0 40px var(--bx-red), 4px 4px 0px black !important;
            animation: none !important; font-size: 40vmin !important; 
        }

        /* 決まり手表示 */
        .effect-finish-style {
            font-family: 'Orbitron', sans-serif !important; 
            font-size: 18vmin !important; 
            line-height: 1.0 !important;
            animation: none !important;
            transform: scale(1.1); 
            white-space: pre-wrap; 
        }
        .ef-spin { color: var(--bx-blue) !important; text-shadow: 0 0 30px var(--bx-blue), 3px 3px 0 black !important; }
        .ef-over { color: var(--bx-orange) !important; text-shadow: 0 0 30px var(--bx-orange), 3px 3px 0 black !important; }
        .ef-burst { color: var(--bx-red-orange) !important; text-shadow: 0 0 30px var(--bx-red-orange), 3px 3px 0 black !important; }
        .ef-xtreme { color: var(--bx-red) !important; text-shadow: 0 0 40px var(--bx-red), 4px 4px 0 black !important; }

        /* インターバル・オープニング用 */
        .interstitial-style {
            font-family: 'Orbitron', sans-serif !important; 
            font-size: 12vmin !important; 
            line-height: 1.1 !important;
            color: white !important; 
            text-shadow: 0 0 20px rgba(255,255,255,0.5), 4px 4px 0 black !important;
            animation: none !important;
            white-space: normal !important;
        }
        .interstitial-small { font-size: 5vmin; display: block; margin-bottom: 5px; color: #ccc; }
        
        .interstitial-huge { 
            font-size: 25vmin; 
            display: block; 
            font-weight: 900; 
            color: var(--bx-yellow); 
            text-shadow: 0 0 20px var(--bx-yellow), 4px 4px 0 black;
            line-height: 0.9; 
            margin: 0; 
        }
        
        .intro-yellow { color: var(--bx-yellow) !important; text-shadow: 0 0 30px var(--bx-yellow), 3px 3px 0 black !important; }
        .intro-red { color: var(--bx-red) !important; text-shadow: 0 0 30px var(--bx-red), 3px 3px 0 black !important; }

    </style>
</head>
<body>
    <video id="camera-bg" autoplay playsinline></video>
    <div class="scan-line"></div>
    <div id="effect-overlay"><div id="effect-text"></div></div>
    
    <div id="battle-counter-area">
        <span id="battle-ordinal" class="battle-ordinal">1st</span>
        <span class="battle-label">BATTLE</span>
    </div>

    <div id="tournament-title-area">
        <input type="text" id="tournament-name-1" class="tournament-input" value="ITABASHI" placeholder="LINE 1">
        <input type="text" id="tournament-name-2" class="tournament-input" value="BEY BATTLE" placeholder="LINE 2">
    </div>

    <div id="p1-wrapper" class="player-wrapper">
        <input type="text" id="name1" class="name-input" value="BLADER 1" placeholder="NAME">
        <div class="stats-row">
            <div class="score-box">
                <div id="score1" class="score">0</div>
                <div class="undo-btn" onclick="undoScore(1)">-1</div>
            </div>
            <div class="buttons-col">
                <div class="hud-btn btn-xtreme" onclick="addScore(1, 3, 'XTREME')"><span>X</span></div>
                <div class="hud-btn btn-burst" onclick="addScore(1, 2, 'BURST')"><span>B</span></div>
                <div class="hud-btn btn-over" onclick="addScore(1, 2, 'OVER')"><span>O</span></div>
                <div class="hud-btn btn-spin" onclick="addScore(1, 1, 'SPIN')"><span>S</span></div>
            </div>
        </div>
    </div>

    <div id="p2-wrapper" class="player-wrapper">
        <input type="text" id="name2" class="name-input" value="BLADER 2" placeholder="NAME">
        <div class="stats-row">
            <div class="score-box">
                <div id="score2" class="score">0</div>
                <div class="undo-btn" onclick="undoScore(2)">-1</div>
            </div>
            <div class="buttons-col">
                <div class="hud-btn btn-xtreme" onclick="addScore(2, 3, 'XTREME')"><span>X</span></div>
                <div class="hud-btn btn-burst" onclick="addScore(2, 2, 'BURST')"><span>B</span></div>
                <div class="hud-btn btn-over" onclick="addScore(2, 2, 'OVER')"><span>O</span></div>
                <div class="hud-btn btn-spin" onclick="addScore(2, 1, 'SPIN')"><span>S</span></div>
            </div>
        </div>
    </div>

    <div id="win-display"></div>

    <button class="system-btn btn-reset" onclick="resetGame()">R</button>
    <button class="system-btn btn-timer-toggle" onclick="toggleTimerDuration()" id="btn-timer-toggle">10</button>
    <button class="system-btn btn-timer" onclick="toggleTimer()">T</button>
    <button class="system-btn btn-bg" onclick="toggleBackground()">B</button>
    <button class="system-btn btn-fullscreen" onclick="toggleFullScreen()">F</button>
    <button class="system-btn btn-rotate" onclick="rotateCamera()">180</button>
    <button class="system-btn btn-winpoint" onclick="toggleWinPoint()" id="btn-winpoint">4</button>

    <script>
        let s1 = 0; let s2 = 0; let isFinished = false;
        let timerInterval = null;
        let isCountingDown = false; 
        
        let timerDuration = 10; 
        
        let effectTimeout = null; 
        let cleanupTimeout = null;
        
        let cursorTimeout = null; 
        let winScoreLimit = 4;
        let battleCount = 1; 

        async function setupCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('camera-bg').srcObject = stream;
            } catch (err) { 
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                    document.getElementById('camera-bg').srcObject = stream;
                } catch (e) { console.log("Camera Error", e); }
            }
        }
        setupCamera();

        function resetCursorTimer() {
            document.body.style.cursor = 'default';
            if (cursorTimeout) clearTimeout(cursorTimeout);
            cursorTimeout = setTimeout(() => {
                document.body.style.cursor = 'none';
            }, 3000); 
        }
        window.addEventListener('mousemove', resetCursorTimer);
        window.addEventListener('touchstart', resetCursorTimer);
        resetCursorTimer();

        function blurFocus() {
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }
        }

        function toggleBackground() {
            blurFocus();
            document.body.classList.toggle('green-mode');
        }

        function rotateCamera() {
            blurFocus();
            const video = document.getElementById('camera-bg');
            video.classList.toggle('camera-rotate-180');
        }

        function toggleWinPoint() {
            blurFocus();
            const btn = document.getElementById('btn-winpoint');
            if (winScoreLimit === 4) {
                winScoreLimit = 2;
                btn.innerText = "2";
            } else {
                winScoreLimit = 4;
                btn.innerText = "4";
            }
        }

        function toggleTimerDuration() {
            blurFocus();
            const btn = document.getElementById('btn-timer-toggle');
            if (timerDuration === 10) {
                timerDuration = 3;
                btn.innerText = "3";
            } else {
                timerDuration = 10;
                btn.innerText = "10";
            }
        }

        function toggleFullScreen() {
            blurFocus();
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function showOverlayText(htmlContent, styleClass, displayTime = 0) {
            const overlay = document.getElementById('effect-overlay');
            const textEl = document.getElementById('effect-text');
            
            clearTimeout(effectTimeout);
            clearTimeout(cleanupTimeout);

            textEl.className = styleClass;
            textEl.innerHTML = htmlContent;
            overlay.style.display = 'flex';
            textEl.classList.remove('fade-out');
            
            if (displayTime > 0) {
                effectTimeout = setTimeout(() => {
                    textEl.classList.add('fade-out');
                    cleanupTimeout = setTimeout(() => {
                        overlay.style.display = 'none';
                        textEl.classList.remove('fade-out');
                    }, 500); 
                }, displayTime);
            }
        }

        function showCenterEffect(text, styleClass, autoHide = true) {
            showOverlayText(text, 'effect-finish-style ' + styleClass, autoHide ? 2000 : 0);
        }

        function showIntro() {
            const t1 = document.getElementById('tournament-name-1').value;
            const t2 = document.getElementById('tournament-name-2').value;
            
            const html = `<span class="intro-yellow">${t1}</span><br><span class="intro-yellow">${t2}</span><br><br><span class="intro-red">Ready......</span>`;
            showOverlayText(html, 'interstitial-style', 4000); 
        }

        function updateBattleCounterDisplay() {
            let suffix = "th";
            if (battleCount === 1) suffix = "st";
            else if (battleCount === 2) suffix = "nd";
            else if (battleCount === 3) suffix = "rd";
            
            let text = `${battleCount}${suffix}`;
            if ( (s1 === winScoreLimit - 1 && s2 === winScoreLimit - 1) || battleCount >= 7 ) {
                text = "FINAL";
            }
            document.getElementById('battle-ordinal').innerText = text;
        }

        function showNextBattle() {
            battleCount++;
            updateBattleCounterDisplay(); 

            let suffix = "th";
            if (battleCount === 2) suffix = "nd";
            else if (battleCount === 3) suffix = "rd";
            
            let centerText = `${battleCount}${suffix}`; 

            if ( (s1 === winScoreLimit - 1) && (s2 === winScoreLimit - 1) ) {
                centerText = "FINAL";
            }
            else if (battleCount >= 7) {
                centerText = "FINAL";
            }

            let html = `NEXT to<br><span class="interstitial-huge">${centerText}</span>BATTLE`;
            showOverlayText(html, 'interstitial-style', 2500); 
        }

        function toggleTimer() {
            blurFocus();
            if (isCountingDown) stopTimer();
            else startTimer();
        }

        function startTimer() {
            isCountingDown = true;
            const overlay = document.getElementById('effect-overlay');
            const textEl = document.getElementById('effect-text');
            
            clearTimeout(effectTimeout);
            clearTimeout(cleanupTimeout);
            
            textEl.className = 'timer-style'; 
            textEl.classList.remove('fade-out'); 
            overlay.style.display = 'flex';
            
            let count = timerDuration;
            textEl.innerText = count;

            timerInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    textEl.innerText = count;
                } else {
                    clearInterval(timerInterval);
                    isCountingDown = false;
                    textEl.innerText = "0";
                    textEl.className = 'ef-time-up'; 
                    
                    cleanupTimeout = setTimeout(() => { 
                        overlay.style.display = 'none'; 
                        textEl.classList.remove('ef-time-up');
                    }, 2000);
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            isCountingDown = false;
            const overlay = document.getElementById('effect-overlay');
            overlay.style.display = 'none';
            document.getElementById('effect-text').className = '';
            clearTimeout(effectTimeout);
            clearTimeout(cleanupTimeout);
        }

        function addScore(player, pts, finishType) {
            blurFocus();
            if (isFinished) return;
            if (isCountingDown) stopTimer(); 

            let styleClass = '';
            switch(finishType) {
                case 'SPIN': styleClass = 'ef-spin'; break;
                case 'OVER': styleClass = 'ef-over'; break;
                case 'BURST': styleClass = 'ef-burst'; break;
                case 'XTREME': styleClass = 'ef-xtreme'; break;
            }
            showCenterEffect(finishType + "<br>FINISH", styleClass, true);

            if (player === 1) {
                s1 = Math.min(s1 + pts, winScoreLimit);
                document.getElementById('score1').innerText = s1;
            } else {
                s2 = Math.min(s2 + pts, winScoreLimit);
                document.getElementById('score2').innerText = s2;
            }

            if ( (player === 1 && s1 >= winScoreLimit) || (player === 2 && s2 >= winScoreLimit) ) {
                isFinished = true; 
                updateBattleCounterDisplay(); 
                setTimeout(() => { finishGame(player); }, 2500); 
            } else {
                setTimeout(() => { showNextBattle(); }, 2500);
            }
        }

        function undoScore(player) {
            blurFocus();
            if (player === 1) {
                if (s1 > 0) {
                    s1 -= 1; 
                    document.getElementById('score1').innerText = s1;
                }
            } else {
                if (s2 > 0) {
                    s2 -= 1;
                    document.getElementById('score2').innerText = s2;
                }
            }
            updateBattleCounterDisplay(); 
        }

        function finishGame(winnerNum) {
            isFinished = true;
            const winLabel = document.getElementById('win-display');
            const nameInput = document.getElementById('name' + winnerNum);
            const playerName = nameInput.value;

            winLabel.innerHTML = `<span class="win-name">${playerName}</span><span class="win-label">WIN</span>`;
            winLabel.classList.add('show-win');
            
            const scoreElem = document.getElementById('score' + winnerNum);
            scoreElem.style.color = "#fff000";
            scoreElem.style.textShadow = "0 0 10px #fff, 0 0 30px #fff000";
        }

        function resetGame() {
            blurFocus();
            s1 = 0; s2 = 0; isFinished = false;
            battleCount = 1; 
            
            updateBattleCounterDisplay(); 

            stopTimer();
            document.getElementById('effect-overlay').style.display = 'none';
            document.getElementById('score1').innerText = 0;
            document.getElementById('score2').innerText = 0;
            const defaultShadow = "0 0 15px rgba(255, 255, 255, 0.8), 3px 3px 0px black";
            document.getElementById('score1').style.color = "white";
            document.getElementById('score1').style.textShadow = defaultShadow;
            document.getElementById('score2').style.color = "white";
            document.getElementById('score2').style.textShadow = defaultShadow;
            document.getElementById('win-display').classList.remove('show-win');

            showIntro();
        }

        window.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT') return;

            const code = e.keyCode;
            if (code === 13) {
                e.preventDefault();
                toggleTimer(); 
                return;
            }

            // P1
            if (code === 103 || code === 55) addScore(1, 3, 'XTREME'); 
            if (code === 100 || code === 52) addScore(1, 2, 'BURST'); 
            if (code === 97 || code === 49)  addScore(1, 2, 'OVER');   
            if (code === 96 || code === 48)  addScore(1, 1, 'SPIN');   
            if (code === 104 || code === 56) undoScore(1);

            // P2
            if (code === 105 || code === 57) addScore(2, 3, 'XTREME'); 
            if (code === 102 || code === 54) addScore(2, 2, 'BURST');  
            if (code === 99 || code === 51)  addScore(2, 2, 'OVER');   
            if (code === 110 || code === 190) addScore(2, 1, 'SPIN');  
            if (code === 98 || code === 50)  undoScore(2);

            if (code === 111 || code === 191) resetGame(); 
        });
    </script>
</body>
</html>